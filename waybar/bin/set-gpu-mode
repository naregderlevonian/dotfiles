#!/bin/sh

GPU_MODE_CONFIG=$HOME/.config/waybar/etc/current-gpu-mode.conf
CURRENT_GPU_MODE=$(cat $GPU_MODE_CONFIG)

function switch_gpu() {
    if pkexec intel-nvidia-switch --switch $1; then
        echo $1 | sed -e 's/\b\(.\)/\u\1/g' > $GPU_MODE_CONFIG
        
        grep -Fxq "source = ~/.config/hypr/hyprland/nvidia.conf" ~/.config/hypr/hyprland.conf &&
        sed -i "\|source = ~/.config/hypr/hyprland/nvidia.conf|d" ~/.config/hypr/hyprland.conf ||
        echo "source = ~/.config/hypr/hyprland/nvidia.conf" >> ~/.config/hypr/hyprland.conf
        
        notify-send 'GPU Changed' $1
        systemctl reboot
    else
        notify-send 'GPU Switch Error'
    fi
}

if [ $CURRENT_GPU_MODE = 'Hybrid' ]; then
    switch_gpu 'intel'
else
    switch_gpu 'hybrid'
fi
